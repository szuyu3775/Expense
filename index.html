<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>致理資教職輔計畫經費控管系統</title>
    <!-- 1. 載入樣式工具 (Tailwind) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. 載入 React 核心 (網頁引擎) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- 3. 載入翻譯機 (Babel)，讓瀏覽器看懂您的程式碼 -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- 設定 Tailwind 自定義動畫 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-in-out',
                        'fade-in-down': 'fadeInDown 0.3s ease-in-out',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        fadeInDown: { '0%': { opacity: '0', transform: 'translateY(-10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } },
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-slate-50 text-slate-800 text-base">
    <!-- 這是 React 程式顯示的「掛載點」 -->
    <div id="root"></div>

    <!-- ★★★ 主程式碼開始 ★★★ -->
    <script type="text/babel" data-type="module">
        const { useState, useEffect, useMemo, useCallback } = React;
        
        // 從網路上載入圖示庫
        import { 
            PlusCircle, Wallet, FileText, AlertCircle, Save, X, Table, Trash2, Plus, 
            CheckCircle2, Calendar, ClipboardList, Coins, ChevronDown, 
            ChevronRight, Settings, Shuffle, Pencil, Check, Loader2, ArrowRightCircle, 
            CheckCircle, RotateCcw, Lock, RefreshCcw, KeyRound, LogOut, Search, User, Filter, ListFilter, Edit, BarChart2, Users, Building2, GraduationCap
        } from 'https://esm.sh/lucide-react@0.263.1?deps=react@18.2.0';

        // --- 設定區 ---
        const API_URL = 'https://script.google.com/macros/s/AKfycbwCT-oLJM6dILv0Lt5J8mH4PhuQ8dyEBvM0VlUpQQqKZek2y4A5arax52eoFsIIQ9gg/exec'; 

        // --- 常數定義 ---
        const EXPENSE_TYPES = ['鐘點費', '諮詢費', '出席費', '補充保費', '餐點費', '材料費', '交通費', '保險費', '雜支', '差旅費', '教材費'];
        const EXPENSE_SORT_ORDER = { '鐘點費': 1, '諮詢費': 2, '出席費': 3, '補充保費': 4, '餐點費': 5, '材料費': 6, '交通費': 7, '保險費': 8, '雜支': 9, '差旅費': 10 };
        const PAYEE_CATEGORIES = ['業師', '個人', '廠商', '勞健保'];
        const BUSINESS_CATEGORIES = ['會報', '活動', '出差', '採購']; 
        const YEARS = [2024, 2025, 2026];
        const MONTHS = ['1月份','2月份','3月份','4月份','5月份','6月份','7月份','8月份','9月份','10月份','11月份','12月份'];
        const STATUS_OPTIONS = ['未核銷', '送核銷', '已歸檔']; 
        const PREMIUM_RATE = 0.0211;
        const PREMIUM_ELIGIBLE_TYPES = ['出席費', '諮詢費', '鐘點費'];

        // --- 樣式設定 ---
        const labelStyle = "block text-sm font-bold text-slate-700 mb-1";
        const inputStyle = "w-full rounded-lg border-2 border-blue-200 text-base py-2 px-3 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-colors bg-white";
        const tableInputStyle = "w-full border-2 border-blue-100 rounded px-2 py-1.5 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 text-sm transition-colors bg-white";
        const tableHeaderStyle = "px-3 py-3 text-left text-xs font-bold text-slate-600 uppercase tracking-wider bg-slate-100 border-b-2 border-slate-300 whitespace-nowrap sticky top-0 z-20 shadow-sm"; 
        const tableCellStyle = "px-1.5 py-2 border-b border-slate-100 align-top";

        // --- 輔助函式 ---
        const getCategoryStyle = (category) => {
            switch (category) {
                case '出差': return 'bg-green-50 text-green-700 border border-green-200';
                case '會報': return 'bg-red-50 text-red-700 border border-red-200';
                case '活動': return 'bg-yellow-50 text-yellow-700 border border-yellow-200';
                case '採購': return 'bg-purple-50 text-purple-700 border border-purple-200';
                default: return 'bg-gray-50 text-gray-600 border border-gray-200';
            }
        };

        const getProjectStyle = (projectName) => {
            if (projectName.includes('課程(補)')) return 'bg-amber-500 text-white'; 
            if (projectName.includes('課程(配)')) return 'bg-yellow-100 text-black'; 
            if (projectName.includes('會報(補)')) return 'bg-red-800 text-white';   
            if (projectName.includes('會報(配)')) return 'bg-pink-200 text-black';   
            if (projectName.includes('雜支(補)')) return 'bg-gray-700 text-white';   
            if (projectName.includes('雜支(配)')) return 'bg-gray-200 text-black';   
            return 'bg-white text-slate-800'; 
        };

        // --- 主應用程式元件 ---
        function ExpenseTrackerApp() {
            // 安全性與登入狀態
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            const [inputCode, setInputCode] = useState('');
            const [authKey, setAuthKey] = useState(''); 
            const [isVerifying, setIsVerifying] = useState(false);

            const [activeTab, setActiveTab] = useState('dashboard');
            const [notification, setNotification] = useState(null);
            
            // 資料狀態
            const [currentYear, setCurrentYear] = useState(new Date().getFullYear());
            const [transactions, setTransactions] = useState([]); 
            const [yearlyBudgets, setYearlyBudgets] = useState([]); 
            
            // 查詢與篩選狀態
            const [searchQuery, setSearchQuery] = useState('');
            const [searchResult, setSearchResult] = useState(null);
            const [filterCategory, setFilterCategory] = useState('全部');
            const [filterStatus, setFilterStatus] = useState('全部');
            const [filterMonth, setFilterMonth] = useState('全部');

            // UI 狀態
            const [isLoading, setIsLoading] = useState(false);
            const [isSaving, setIsSaving] = useState(false);
            const [savingMessage, setSavingMessage] = useState('處理中...');
            const [dataLoaded, setDataLoaded] = useState(false);

            // 編輯與新增狀態
            const [editingId, setEditingId] = useState(null);
            const [editFormData, setEditFormData] = useState({});
            
            // 群組編輯狀態
            const [editingGroupKey, setEditingGroupKey] = useState(null);
            const [editGroupData, setEditGroupData] = useState({});

            // 專案設定
            const [projects] = useState([
                { id: 1, name: '職涯-課程(補)', type: 'subsidy', description: '教育部補助' },
                { id: 2, name: '職涯-課程(配)', type: 'matching', description: '學校配合款' },
                { id: 3, name: '職涯-會報(補)', type: 'subsidy', description: '教育部補助' },
                { id: 4, name: '職涯-會報(配)', type: 'matching', description: '學校配合款' },
                { id: 5, name: '職涯-雜支(補)', type: 'subsidy', description: '教育部補助' },
                { id: 6, name: '職涯-雜支(配)', type: 'matching', description: '學校配合款' },
            ]);

            const [batchHeader, setBatchHeader] = useState({ 
                id: '', 
                year: currentYear, 
                month: '1月份', 
                status: '未核銷', 
                activityName: '', 
                archiveDate: '',
                businessCategory: '會報' 
            });
            const [batchItems, setBatchItems] = useState([{ id: Date.now(), project: projects[0].name, expenseType: '諮詢費', item: '', payeeCategory: '業師', payeeName: '', unitPrice: '', quantity: 1 }]);
            const [expandedGroups, setExpandedGroups] = useState({});
            const [modalConfig, setModalConfig] = useState({ isOpen: false, type: '', items: [], inputValue: '' });

            // --- API 連線邏輯 ---
            const fetchAllData = useCallback(async (key) => {
                if (!API_URL) return false;
                setIsLoading(true);
                try {
                    const [transRes, budgetRes] = await Promise.all([
                        fetch(`${API_URL}?type=transactions&authCode=${key}`),
                        fetch(`${API_URL}?type=budgets&authCode=${key}`)
                    ]);
                    
                    const transResponse = await transRes.json();
                    const budgetResponse = await budgetRes.json();

                    if (transResponse.status === 'error' || budgetResponse.status === 'error') {
                        throw new Error(transResponse.message || budgetResponse.message || '存取被拒絕，請檢查密碼');
                    }

                    const transData = transResponse.data || [];
                    const budgetData = budgetResponse.data || [];

                    const safeTransData = Array.isArray(transData) ? transData.map(t => ({
                        ...t,
                        year: Number(t.year),
                        unitPrice: Number(t.unitPrice),
                        quantity: Number(t.quantity),
                        amount: Number(t.amount)
                    })) : [];

                    const safeBudgetData = Array.isArray(budgetData) ? budgetData.map(b => ({
                        ...b,
                        year: Number(b.year),
                        amount: Number(b.amount)
                    })) : [];

                    setTransactions(safeTransData);
                    setYearlyBudgets(safeBudgetData);
                    setDataLoaded(true);
                    return true;
                } catch (error) {
                    const isAuthError = error.message.includes('密碼') || error.message.includes('拒絕');
                    
                    if (isAuthError) {
                        console.warn('Authentication failed:', error.message);
                        if (isAuthenticated) {
                             showNotification('密碼驗證失敗，請重新登入', 'error');
                        }
                        handleLogout(); // 確保清除錯誤的 storage
                    } else {
                        console.error('Fetch Error:', error);
                        if (isAuthenticated) {
                             showNotification('連線失敗，請檢查網路設定', 'error');
                        }
                    }
                    return false;
                } finally {
                    setIsLoading(false);
                }
            }, [isAuthenticated]);

            const postToGAS = async (action, data) => {
                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        body: JSON.stringify({ action, data, authCode: authKey }),
                    });
                    const result = await response.json();
                    if (result.status === 'error') {
                        throw new Error(result.message);
                    }
                    return true;
                } catch (error) {
                    console.error('Post Error:', error);
                    showNotification(error.message, 'error');
                    return false;
                }
            };

            const handleLogin = async (e) => {
                e.preventDefault();
                if (!inputCode) {
                    alert('請輸入通行密碼');
                    return;
                }
                setIsVerifying(true);
                
                try {
                    const success = await fetchAllData(inputCode);
                    if (success) {
                        setIsAuthenticated(true);
                        setAuthKey(inputCode); 
                        localStorage.setItem('expense_app_key', inputCode);
                        showNotification('登入成功', 'success');
                    } else {
                        alert('密碼錯誤，請重新輸入');
                    }
                } catch (e) {
                    alert('登入過程發生錯誤');
                }
                setIsVerifying(false);
            };

            const handleLogout = () => {
                setIsAuthenticated(false);
                setAuthKey('');
                setTransactions([]);
                setYearlyBudgets([]);
                setDataLoaded(false);
                localStorage.removeItem('expense_app_key');
            };

            useEffect(() => {
                const savedKey = localStorage.getItem('expense_app_key');
                if (savedKey) {
                    setIsVerifying(true);
                    fetchAllData(savedKey).then(success => {
                        if (success) {
                            setAuthKey(savedKey);
                            setIsAuthenticated(true);
                        } else {
                            localStorage.removeItem('expense_app_key');
                        }
                        setIsVerifying(false);
                    });
                }
            }, []); 

            useEffect(() => {
                setBatchHeader(prev => ({ ...prev, year: currentYear }));
            }, [currentYear]);

            // --- 計算邏輯 ---
            const commonPayees = useMemo(() => {
                const names = new Set(transactions.filter(t => t.payeeCategory === '業師').map(t => t.payeeName));
                return Array.from(names);
            }, [transactions]);

            const currentYearTransactions = useMemo(() => {
                return transactions.filter(t => t.year === currentYear);
            }, [transactions, currentYear]);

            // 查詢邏輯
            useEffect(() => {
                if (activeTab === 'query' && searchQuery) {
                    const results = currentYearTransactions.filter(t => t.payeeName === searchQuery.trim());
                    setSearchResult({
                        count: results.length,
                        totalAmount: results.reduce((sum, item) => sum + item.amount, 0),
                        items: results
                    });
                } else if (activeTab === 'query' && !searchQuery) {
                    setSearchResult(null);
                }
            }, [searchQuery, currentYearTransactions, activeTab]);

            // 年度對象名錄計算
            const payeeSummary = useMemo(() => {
                const summary = { '業師': [], '個人': [], '廠商': [] };
                const map = {}; 

                currentYearTransactions.forEach(t => {
                    const key = `${t.payeeCategory}-${t.payeeName}`;
                    if (!map[key]) {
                        map[key] = { category: t.payeeCategory, name: t.payeeName, count: 0, total: 0 };
                    }
                    map[key].count += 1;
                    map[key].total += Number(t.amount);
                });

                Object.values(map).forEach(item => {
                    if (summary[item.category]) {
                        summary[item.category].push(item);
                    }
                });

                Object.keys(summary).forEach(cat => {
                    summary[cat].sort((a, b) => b.total - a.total);
                });

                return summary;
            }, [currentYearTransactions]);

            const matrixReport = useMemo(() => {
                const rowMap = new Map();
                currentYearTransactions.forEach(t => {
                    const rowKey = `${t.month}-${t.businessCategory}-${t.activityName}`;
                    if (!rowMap.has(rowKey)) {
                        rowMap.set(rowKey, {
                            month: t.month,
                            businessCategory: t.businessCategory || '無',
                            activityName: t.activityName,
                            total: 0,
                            projectAmounts: {} 
                        });
                    }
                    const row = rowMap.get(rowKey);
                    const amount = Number(t.amount);
                    row.projectAmounts[t.project] = (row.projectAmounts[t.project] || 0) + amount;
                    row.total += amount;
                });
                const rows = Array.from(rowMap.values()).sort((a, b) => {
                     const mA = parseInt((a.month || '').replace(/\D/g, '')) || 0;
                     const mB = parseInt((b.month || '').replace(/\D/g, '')) || 0;
                     return mA - mB;
                });
                const colTotals = {};
                projects.forEach(p => colTotals[p.name] = 0);
                let grandTotal = 0;
                rows.forEach(r => {
                    projects.forEach(p => {
                        const val = r.projectAmounts[p.name] || 0;
                        colTotals[p.name] = (colTotals[p.name] || 0) + val;
                    });
                    grandTotal += r.total;
                });
                return { rows, colTotals, grandTotal };
            }, [currentYearTransactions, projects]);

            // 統計計算邏輯
            const projectStats = useMemo(() => {
                const statsMap = {};
                projects.forEach(p => {
                    statsMap[p.name] = { totalUsed: 0, archived: 0, submitted: 0, unsubmitted: 0 };
                });

                currentYearTransactions.forEach(t => {
                    const projName = t.project;
                    if (statsMap[projName]) {
                        const amount = Number(t.amount);
                        statsMap[projName].totalUsed += amount;
                        if (t.status === '已歸檔') statsMap[projName].archived += amount;
                        else if (t.status === '送核銷') statsMap[projName].submitted += amount;
                        else if (t.status === '未核銷') statsMap[projName].unsubmitted += amount;
                    }
                });

                return projects.map(proj => {
                    const budgetRecord = yearlyBudgets.find(b => Number(b.year) === currentYear && Number(b.projectId) === proj.id);
                    const yearBudget = budgetRecord ? Number(budgetRecord.amount) : 0;
                    
                    const stats = statsMap[proj.name];
                    const totalUsed = stats.totalUsed;
                    const ratio = yearBudget > 0 ? ((totalUsed / yearBudget) * 100) : 0;

                    return {
                        ...proj, 
                        totalBudget: yearBudget, 
                        archived: stats.archived, 
                        submitted: stats.submitted, 
                        unsubmitted: stats.unsubmitted, 
                        totalUsed,
                        remaining: yearBudget - totalUsed, 
                        ratio: ratio.toFixed(2), 
                        isOverLimit: totalUsed > yearBudget * 1.2
                    };
                });
            }, [projects, currentYearTransactions, yearlyBudgets, currentYear]);

            // 計算儀表板總計列
            const dashboardTotals = useMemo(() => {
                return projectStats.reduce((acc, curr) => ({
                    totalBudget: acc.totalBudget + curr.totalBudget,
                    totalUsed: acc.totalUsed + curr.totalUsed,
                    remaining: acc.remaining + curr.remaining,
                    archived: acc.archived + curr.archived,
                    submitted: acc.submitted + curr.submitted,
                    unsubmitted: acc.unsubmitted + curr.unsubmitted
                }), { totalBudget: 0, totalUsed: 0, remaining: 0, archived: 0, submitted: 0, unsubmitted: 0 });
            }, [projectStats]);

            const summaryStats = useMemo(() => {
                let subsidy = { budget: 0, used: 0, archived: 0 };
                let matching = { budget: 0, used: 0, archived: 0 };
                
                projectStats.forEach(stat => {
                    if (stat.type === 'subsidy') { 
                        subsidy.budget += stat.totalBudget; 
                        subsidy.used += stat.totalUsed; 
                        subsidy.archived += stat.archived; 
                    }
                    else { 
                        matching.budget += stat.totalBudget; 
                        matching.used += stat.totalUsed;
                        matching.archived += stat.archived;
                    }
                });

                const subsidyRemaining = subsidy.budget - subsidy.used;
                const matchingRemaining = matching.budget - matching.used;

                const subsidyDisplayUsed = subsidy.archived;
                const subsidyDisplayRemaining = subsidy.budget - subsidyDisplayUsed;
                const subsidyRatio = subsidy.budget > 0 ? (subsidyDisplayUsed / subsidy.budget) * 100 : 0;

                const matchingDisplayUsed = matching.archived;
                const matchingDisplayRemaining = matching.budget - matchingDisplayUsed;
                const matchingRatio = matching.budget > 0 ? (matchingDisplayUsed / matching.budget) * 100 : 0;

                return {
                    subsidy: { 
                        remaining: subsidyRemaining, 
                        displayUsed: subsidyDisplayUsed,
                        displayRemaining: subsidyDisplayRemaining,
                        displayTotal: subsidy.budget,
                        ratio: subsidyRatio
                    },
                    matching: { 
                        remaining: matchingRemaining,
                        displayUsed: matchingDisplayUsed,
                        displayRemaining: matchingDisplayRemaining,
                        displayTotal: matching.budget,
                        ratio: matchingRatio
                    }
                };
            }, [projectStats]);

            const groupedTransactions = useMemo(() => {
                const groups = {};
                const filteredTransactions = currentYearTransactions.filter(t => {
                    const matchCategory = filterCategory === '全部' || t.businessCategory === filterCategory;
                    const matchStatus = filterStatus === '全部' || t.status === filterStatus;
                    const matchMonth = filterMonth === '全部' || t.month === filterMonth;
                    return matchCategory && matchStatus && matchMonth;
                });
                filteredTransactions.forEach(t => {
                    const groupKey = `${t.month}-${t.id || 'pending'}-${t.activityName}-${t.businessCategory}`;
                    if (!groups[groupKey]) {
                        groups[groupKey] = {
                            key: groupKey, 
                            id: t.id, 
                            month: t.month, 
                            activityName: t.activityName, 
                            businessCategory: t.businessCategory || '', 
                            status: t.status, 
                            archiveDate: t.archiveDate,
                            items: [], totalAmount: 0, subsidyAmount: 0, matchingAmount: 0
                        };
                    }
                    const amount = Number(t.amount);
                    groups[groupKey].items.push(t);
                    groups[groupKey].totalAmount += amount;
                    
                    const proj = projects.find(p => p.name === t.project);
                    if (proj) {
                        if (proj.type === 'subsidy') groups[groupKey].subsidyAmount += amount;
                        else groups[groupKey].matchingAmount += amount;
                    }
                });
                const getMonthNum = (m) => parseInt(m.replace('月份', '')) || 0;
                const result = Object.values(groups).sort((a, b) => {
                    const monthDiff = getMonthNum(b.month) - getMonthNum(a.month); 
                    if (monthDiff !== 0) return monthDiff;
                    const STATUS_ORDER = { '未核銷': 0, '送核銷': 1, '已歸檔': 2 };
                    return (STATUS_ORDER[a.status] || 0) - (STATUS_ORDER[b.status] || 0);
                });
                result.forEach(group => {
                    group.items.sort((a, b) => {
                        const orderA = EXPENSE_SORT_ORDER[a.expenseType] || 999;
                        const orderB = EXPENSE_SORT_ORDER[b.expenseType] || 999;
                        return orderA - orderB;
                    });
                });
                return result;
            }, [currentYearTransactions, projects, filterCategory, filterStatus, filterMonth]); 

            const handleBudgetUpdate = async (projectId, amount) => {
                const numAmount = Number(amount);
                setYearlyBudgets(prev => {
                    const exists = prev.find(b => Number(b.year) === currentYear && Number(b.projectId) === projectId);
                    if (exists) return prev.map(b => Number(b.year) === currentYear && Number(b.projectId) === projectId ? { ...b, amount: numAmount } : b);
                    return [...prev, { year: currentYear, projectId, amount: numAmount }];
                });
                
                setIsSaving(true);
                setSavingMessage('儲存預算中...');
                await postToGAS('updateBudget', { year: currentYear, projectId, amount: numAmount });
                setIsSaving(false);
                showNotification('預算已儲存', 'success');
            };

            const handleHeaderChange = (e) => {
                const { name, value } = e.target;
                setBatchHeader(prev => {
                    const newState = { ...prev, [name]: value };
                    if (name === 'year') setCurrentYear(Number(value));
                    return newState;
                });
            };

            const handleItemChange = (id, field, value) => {
                setBatchItems(prev => prev.map(item => {
                    if (item.id !== id) return item;
                    const newUpdates = { [field]: value };
                    if (field === 'payeeCategory' && value === '勞健保') {
                        newUpdates.payeeName = '22565124代扣保費';
                    }
                    return { ...item, ...newUpdates };
                }));
            };

            const addItemRow = () => {
                setBatchItems(prev => {
                    const lastItem = prev[prev.length - 1];
                    return [...prev, { 
                        id: Date.now(), 
                        project: lastItem ? lastItem.project : projects[0].name, 
                        expenseType: lastItem ? lastItem.expenseType : '諮詢費', 
                        item: '', 
                        payeeCategory: '業師', 
                        payeeName: '', 
                        unitPrice: '', 
                        quantity: 1 
                    }];
                });
            };
            
            const removeItemRow = (id) => {
                if (batchItems.length === 1) { showNotification('至少一筆', 'error'); return; }
                setBatchItems(prev => prev.filter(item => item.id !== id));
            };

            const addPremiumRow = () => {
                const eligible = batchItems.reduce((sum, i) => PREMIUM_ELIGIBLE_TYPES.includes(i.expenseType) ? sum + (Number(i.unitPrice)*Number(i.quantity)) : sum, 0);
                if (eligible <= 0) { showNotification('無符合項目', 'error'); return; }
                setBatchItems(prev => [...prev, { id: Date.now(), project: projects[0].name, expenseType: '補充保費', item: '二代健保補充保費', payeeCategory: '勞健保', payeeName: '22565124代扣保費', unitPrice: Math.round(eligible*PREMIUM_RATE), quantity: 1 }]);
                showNotification('已新增保費', 'success');
            };

            const handleBatchSubmit = async (e) => {
                e.preventDefault();
                if (!batchHeader.activityName.trim()) { showNotification('需填活動名稱', 'error'); return; }
                if (!batchItems.every(i => i.unitPrice && i.quantity && i.project && i.payeeName && i.payeeName.trim())) { 
                    showNotification('欄位不完整 (請檢查金額、經費來源及人員/單位名稱)', 'error'); 
                    return; 
                }

                let batchSubsidyTotal = 0;
                let batchMatchingTotal = 0;

                batchItems.forEach(item => {
                    const projectDef = projects.find(p => p.name === item.project);
                    const amount = Math.round(Number(item.unitPrice) * Number(item.quantity));
                    if (projectDef) {
                        if (projectDef.type === 'subsidy') batchSubsidyTotal += amount;
                        if (projectDef.type === 'matching') batchMatchingTotal += amount;
                    }
                });

                if (batchSubsidyTotal > summaryStats.subsidy.remaining) {
                    showNotification(`補助款超支！本批需 ${formatCurrency(batchSubsidyTotal)}，但僅剩 ${formatCurrency(summaryStats.subsidy.remaining)}`, 'error');
                    return;
                }
                if (batchMatchingTotal > summaryStats.matching.remaining) {
                    showNotification(`配合款超支！本批需 ${formatCurrency(batchMatchingTotal)}，但僅剩 ${formatCurrency(summaryStats.matching.remaining)}`, 'error');
                    return;
                }

                const newTrans = batchItems.map((item, idx) => ({
                    uid: `new_${Date.now()}_${idx}`, id: '', year: Number(batchHeader.year), month: batchHeader.month, activityName: batchHeader.activityName, businessCategory: batchHeader.businessCategory, project: item.project, expenseType: item.expenseType, item: item.item, payeeCategory: item.payeeCategory, payeeName: item.payeeName, unitPrice: Number(item.unitPrice), quantity: Number(item.quantity), amount: Math.round(Number(item.unitPrice)*Number(item.quantity)), status: '未核銷', archiveDate: ''
                }));

                setIsSaving(true);
                setSavingMessage('正在新增支出...');
                const success = await postToGAS('createBatch', newTrans);
                if (success) {
                    await fetchAllData(authKey); 
                    showNotification('新增成功', 'success');
                    setBatchHeader(prev => ({...prev, id: '', activityName: '', archiveDate: ''}));
                    setBatchItems([{ id: Date.now(), project: projects[0].name, expenseType: '諮詢費', item: '', payeeCategory: '業師', payeeName: '', unitPrice: '', quantity: 1 }]);
                } else {
                    showNotification('儲存失敗，請重試', 'error');
                }
                setIsSaving(false);
            };

            const handleStartEdit = (item) => { setEditingId(item.uid); setEditFormData({...item}); };
            const handleCancelEdit = () => { setEditingId(null); setEditFormData({}); };
            const handleSaveEdit = async () => {
                const updatedItem = { ...editFormData, amount: Math.round(Number(editFormData.unitPrice)*Number(editFormData.quantity)) };
                setIsSaving(true);
                setSavingMessage('更新資料中...');
                const success = await postToGAS('update', updatedItem);
                if (success) {
                    await fetchAllData(authKey);
                    setEditingId(null); 
                    setEditFormData({});
                    showNotification('修改成功', 'success');
                } else {
                    showNotification('更新失敗', 'error');
                }
                setIsSaving(false);
            };
            const handleEditFormChange = (f, v) => setEditFormData(prev => ({...prev, [f]: v}));

            const handleStartGroupEdit = (group) => {
                setEditingGroupKey(group.key);
                setEditGroupData({
                    month: group.month,
                    activityName: group.activityName,
                    businessCategory: group.businessCategory
                });
            };

            const handleCancelGroupEdit = () => {
                setEditingGroupKey(null);
                setEditGroupData({});
            };

            const handleSaveGroupEdit = async (originalGroupItems) => {
                setIsSaving(true);
                setSavingMessage('正在更新活動資訊...');
                try {
                    let hasError = false;
                    for (const item of originalGroupItems) {
                        const updatedItem = { 
                            ...item, 
                            month: editGroupData.month,
                            activityName: editGroupData.activityName,
                            businessCategory: editGroupData.businessCategory
                        };
                        const result = await postToGAS('update', updatedItem);
                        if (!result) hasError = true;
                    }
                    await fetchAllData(authKey);
                    if (hasError) {
                        showNotification('部分資料更新失敗', 'error');
                    } else {
                        showNotification('活動資訊更新成功', 'success');
                        setEditingGroupKey(null);
                        setEditGroupData({});
                    }
                } catch (err) {
                    console.error(err);
                    showNotification('更新發生錯誤', 'error');
                } finally {
                    setIsSaving(false);
                }
            };

            const handleDeleteGroup = (e, groupItems) => {
                e.stopPropagation(); 
                setModalConfig({ isOpen: true, type: 'confirm_delete_group', items: groupItems, inputValue: '' });
            };

            const handleOpenStatusModal = (e, type, items) => {
                e.stopPropagation();
                
                let defaultInputValue = '';
                
                if (type === 'promote_to_archived') {
                    const today = new Date();
                    const yyyy = today.getFullYear();
                    const mm = String(today.getMonth() + 1).padStart(2, '0');
                    const dd = String(today.getDate()).padStart(2, '0');
                    defaultInputValue = `${yyyy}-${mm}-${dd}`;
                }

                if (type === 'rollback_to_pending') {
                    setModalConfig({ isOpen: true, type: 'confirm_rollback_to_pending', items, inputValue: '' });
                    return;
                }
                if (type === 'rollback_to_submitted') {
                    setModalConfig({ isOpen: true, type: 'confirm_rollback_to_submitted', items, inputValue: '' });
                    return;
                }
                setModalConfig({ isOpen: true, type, items, inputValue: defaultInputValue });
            };

            const handleStatusSubmit = async (e) => {
                e.preventDefault();
                const { type, items, inputValue } = modalConfig;
                let success = false;
                setModalConfig({ isOpen: false, type: '', items: [], inputValue: '' });

                if (type === 'confirm_delete_group') {
                    const uids = items.map(i => i.uid); 
                    setIsSaving(true);
                    setSavingMessage('正在刪除...');
                    success = await postToGAS('delete', uids);
                    await fetchAllData(authKey);
                    if(success) showNotification('已刪除整筆活動資料', 'success');
                    else showNotification('刪除失敗', 'error');
                    setIsSaving(false);
                } else {
                    setIsSaving(true);
                    setSavingMessage('正在更新狀態 (請勿關閉視窗)...');
                    try {
                        let hasError = false;
                        for (const item of items) {
                            let newItem = { ...item };
                            if (type === 'promote_to_submitted') {
                                if (!inputValue.trim()) continue;
                                newItem.status = '送核銷'; newItem.id = inputValue.trim(); newItem.archiveDate = '';
                            } else if (type === 'promote_to_archived') {
                                if (!inputValue) continue;
                                newItem.status = '已歸檔'; newItem.archiveDate = inputValue;
                            } else if (type === 'confirm_rollback_to_pending') {
                                newItem.status = '未核銷'; newItem.id = ''; newItem.archiveDate = '';
                            } else if (type === 'confirm_rollback_to_submitted') {
                                newItem.status = '送核銷'; newItem.archiveDate = '';
                            }
                            const result = await postToGAS('update', newItem);
                            if (!result) hasError = true;
                        }
                        await fetchAllData(authKey); 
                        if (hasError) showNotification('部分資料更新失敗，請檢查', 'error');
                        else if (type.includes('rollback')) showNotification('狀態已退回', 'success');
                        else showNotification('狀態已更新', 'success');
                    } catch (err) {
                        console.error(err);
                        showNotification('操作發生錯誤', 'error');
                    } finally {
                        setIsSaving(false);
                    }
                }
            };

            const handlePayeeClick = (name) => {
                setSearchQuery(name);
            };

            const toggleGroup = (key) => setExpandedGroups(prev => ({...prev, [key]: !prev[key]}));
            const showNotification = (msg, type) => { setNotification({ msg, type }); setTimeout(() => setNotification(null), 3000); };
            const formatCurrency = (n) => new Intl.NumberFormat('zh-TW', { style: 'currency', currency: 'TWD', minimumFractionDigits: 0 }).format(n);
            const batchTotal = batchItems.reduce((sum, i) => sum + (Math.round(Number(i.unitPrice)*Number(i.quantity)) || 0), 0);

            if (!isAuthenticated) {
                return (
                    <div className="min-h-screen bg-slate-100 flex items-center justify-center font-sans">
                        <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-sm animate-fade-in-down border border-slate-200">
                            <div className="flex flex-col items-center mb-6">
                                <div className="bg-blue-600 p-3 rounded-xl mb-3 shadow-lg shadow-blue-200"><Wallet className="h-8 w-8 text-white" /></div>
                                <h2 className="text-xl font-bold text-slate-800">致理資教職輔計畫經費控管系統</h2>
                                <p className="text-sm text-slate-500">經費控管系統 (Secure)</p>
                            </div>
                            <form onSubmit={handleLogin} className="space-y-4">
                                <div>
                                    <label className="block text-xs font-medium text-slate-500 mb-1 ml-1">通行密碼</label>
                                    <div className="relative">
                                        <KeyRound className="w-4 h-4 text-slate-400 absolute left-3 top-3" />
                                        <input 
                                            type="password" 
                                            value={inputCode} 
                                            onChange={(e) => setInputCode(e.target.value)} 
                                            className="w-full pl-10 pr-4 py-2.5 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all"
                                            placeholder="請輸入密碼"
                                            autoFocus
                                        />
                                    </div>
                                </div>
                                <button type="submit" disabled={isVerifying} className="w-full bg-blue-600 hover:bg-blue-700 disabled:bg-slate-400 text-white font-bold py-2.5 rounded-lg shadow-md hover:shadow-lg transition-all transform active:scale-95 flex justify-center items-center gap-2">
                                    {isVerifying ? <Loader2 className="w-5 h-5 animate-spin" /> : '進入系統'}
                                </button>
                            </form>
                            <div className="text-center mt-6">
                                <p className="text-xs text-slate-400">© 2025 Expense Tracker Pro</p>
                                <p className="text-[10px] text-slate-300 mt-1">v2.6.4 | 更新時間：2026/01/22 11:24</p>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-slate-50 text-slate-800 font-sans relative">
                    {/* 遮罩 */}
                    {(isLoading || isSaving) && (
                        <div className="fixed inset-0 bg-white/60 z-50 flex items-center justify-center backdrop-blur-sm">
                            <div className="flex flex-col items-center p-6 bg-white rounded-xl shadow-xl border border-slate-100">
                                <Loader2 className="w-10 h-10 animate-spin text-blue-600 mb-3" />
                                <p className="text-slate-600 font-medium animate-pulse">{isSaving ? savingMessage : '正在讀取資料...'}</p>
                            </div>
                        </div>
                    )}

                    {modalConfig.isOpen && (
                        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center animate-fade-in">
                            <div className="bg-white rounded-xl shadow-2xl p-6 w-96 animate-fade-in-down">
                                <div className="flex justify-between items-center mb-4 border-b border-slate-100 pb-2">
                                    <h3 className="font-bold text-lg text-slate-700">
                                        {modalConfig.type === 'promote_to_submitted' && '送出核銷'}
                                        {modalConfig.type === 'promote_to_archived' && '完成歸檔'}
                                        {modalConfig.type.includes('rollback') && '確認退回'}
                                        {modalConfig.type === 'confirm_delete_group' && '確認刪除'}
                                    </h3>
                                    <button onClick={() => setModalConfig({...modalConfig, isOpen: false})} className="text-slate-400 hover:text-slate-600"><X className="w-5 h-5" /></button>
                                </div>
                                <form onSubmit={handleStatusSubmit}>
                                    <div className="mb-4">
                                        {modalConfig.type.startsWith('confirm_') ? (
                                            <div className="text-slate-600">
                                                {modalConfig.type === 'confirm_rollback_to_pending' && '確定要將此筆活動退回至「未核銷」狀態嗎？核銷單號將會被清除，退回後可重新編輯明細。'}
                                                {modalConfig.type === 'confirm_rollback_to_submitted' && '確定要將此筆活動退回至「送核銷」狀態嗎？歸檔日期將會被清除，但保留核銷單號。'}
                                                {modalConfig.type === 'confirm_delete_group' && `確定要刪除「${modalConfig.items[0]?.activityName}」及其包含的 ${modalConfig.items.length} 筆明細嗎？此動作無法復原。`}
                                            </div>
                                        ) : (
                                            <>
                                                <label className="block text-sm font-medium text-slate-600 mb-2">
                                                    {modalConfig.type === 'promote_to_submitted' ? '請輸入核銷單號 (輸入後即變更為送核銷)' : '請選擇歸檔日期 (選擇後即變更為已歸檔)'}
                                                </label>
                                                {modalConfig.type === 'promote_to_submitted' ? (
                                                    <input type="text" autoFocus required placeholder="例: AC2025099" value={modalConfig.inputValue} onChange={e => setModalConfig({...modalConfig, inputValue: e.target.value})} className={inputStyle} />
                                                ) : (
                                                    <input type="date" required value={modalConfig.inputValue} onChange={e => setModalConfig({...modalConfig, inputValue: e.target.value})} className={inputStyle} />
                                                )}
                                            </>
                                        )}
                                    </div>
                                    <div className="flex justify-end gap-2">
                                        <button type="button" onClick={() => setModalConfig({...modalConfig, isOpen: false})} className="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg text-sm font-medium">取消</button>
                                        <button type="submit" className={`px-4 py-2 text-white rounded-lg text-sm font-bold ${modalConfig.type === 'confirm_delete_group' ? 'bg-red-600 hover:bg-red-700' : modalConfig.type.startsWith('confirm_') ? 'bg-red-500 hover:bg-red-600' : (modalConfig.type === 'promote_to_submitted' ? 'bg-blue-600 hover:bg-blue-700' : 'bg-green-600 hover:bg-green-700')}`}>
                                            {modalConfig.type === 'confirm_delete_group' ? '確認刪除' : modalConfig.type.startsWith('confirm_') ? '確認退回' : '確認變更'}
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}

                    <div className="bg-white shadow-sm border-b border-slate-200 sticky top-0 z-10">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <div className="flex justify-between items-center h-16">
                                <div className="flex items-center gap-2">
                                    <div className="bg-blue-600 p-2 rounded-lg"><Wallet className="h-6 w-6 text-white" /></div>
                                    <span className="font-bold text-xl text-slate-800 tracking-tight">致理資教職輔計畫經費控管系統</span>
                                </div>
                                <div className="flex space-x-1 bg-slate-100 p-1 rounded-lg">
                                    {['dashboard', 'entry', 'log', 'report', 'query', 'settings'].map(tab => (
                                        <button key={tab} onClick={() => setActiveTab(tab)} className={`px-4 py-2 rounded-md text-sm font-medium transition-all duration-200 flex items-center gap-1 ${activeTab === tab ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}>
                                            {tab === 'dashboard' && '經費執行情形'}
                                            {tab === 'entry' && '支出登錄'}
                                            {tab === 'log' && '明細紀錄'}
                                            {tab === 'report' && '經費支出一覽表'}
                                            {tab === 'query' && '查詢統計'}
                                            {tab === 'settings' && <><Settings className="w-4 h-4" /> 預算設定</>}
                                        </button>
                                    ))}
                                    <button onClick={handleLogout} className="px-3 py-2 text-slate-400 hover:text-red-500 transition-colors" title="登出"><LogOut className="w-5 h-5" /></button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                        {notification && (
                            <div className={`mb-6 p-4 rounded-lg flex items-center gap-3 shadow-sm animate-fade-in-down ${notification.type === 'success' ? 'bg-green-50 text-green-700 border border-green-200' : 'bg-red-50 text-red-700 border border-red-200'}`}>
                                {notification.type === 'success' ? <Save className="h-5 w-5" /> : <AlertCircle className="h-5 w-5" />} <span className="font-medium">{notification.msg}</span>
                            </div>
                        )}

                        <div className="mb-6 flex justify-between items-center">
                            <div className="flex items-center gap-3">
                                <h2 className="text-xl font-bold text-slate-700">
                                    {activeTab === 'dashboard' && '經費執行情形'}
                                    {activeTab === 'entry' && '支出登錄'}
                                    {activeTab === 'log' && '明細紀錄'}
                                    {activeTab === 'report' && '經費支出一覽表'}
                                    {activeTab === 'query' && '查詢統計'}
                                    {activeTab === 'settings' && '系統設定'}
                                </h2>
                                {!dataLoaded && <span className="text-xs text-red-500 bg-red-50 px-2 py-1 rounded-full border border-red-100 flex items-center gap-1"><AlertCircle className="w-3 h-3"/> 尚未連線至資料庫</span>}
                            </div>
                            <div className="flex items-center gap-2">
                                <button onClick={() => fetchAllData(authKey)} className="p-2 text-slate-400 hover:text-blue-600 hover:bg-blue-50 rounded-full transition-colors" title="重新讀取資料"><RefreshCcw className="w-5 h-5"/></button>
                                <div className="flex items-center gap-2 bg-white px-4 py-2 rounded-lg shadow-sm border border-slate-200">
                                    <Calendar className="w-5 h-5 text-blue-600" />
                                    <span className="text-sm font-medium text-slate-600">目前檢視年度：</span>
                                    <select value={currentYear} onChange={(e) => setCurrentYear(Number(e.target.value))} className="text-lg font-bold text-slate-800 border-none bg-transparent focus:ring-0 cursor-pointer hover:text-blue-600">
                                        {YEARS.map(y => <option key={y} value={y}>{y}年</option>)}
                                    </select>
                                </div>
                            </div>
                        </div>

                        {!dataLoaded ? (
                            <div className="flex flex-col items-center justify-center h-64 text-slate-400">
                                <p>請先設定 API 網址並確保 Google 試算表已建立...</p>
                            </div>
                        ) : (
                            <>
                                {/* Settings Tab */}
                                {activeTab === 'settings' && (
                                    <div className="max-w-3xl mx-auto animate-fade-in">
                                        <div className="bg-white rounded-xl shadow-lg border border-slate-100 overflow-hidden">
                                            <div className="bg-slate-700 px-6 py-4 text-white flex justify-between items-center">
                                                <h3 className="font-bold text-lg flex items-center gap-2"><Settings className="h-5 w-5" /> {currentYear}年度 預算設定</h3>
                                                <span className="text-sm bg-slate-600 px-2 py-1 rounded">修改後自動儲存</span>
                                            </div>
                                            <div className="p-6 space-y-3">
                                                {projects.map(proj => {
                                                    const budget = yearlyBudgets.find(b => Number(b.year) === currentYear && Number(b.projectId) === proj.id)?.amount || 0;
                                                    return (
                                                        <div key={`${proj.id}-${currentYear}`} className="flex items-center justify-between p-4 bg-slate-50 rounded-lg border border-slate-200">
                                                            <div>
                                                                <div className="flex items-center gap-2">
                                                                    <p className="font-medium text-slate-800">{proj.name}</p>
                                                                    <span className={`text-[10px] px-2 py-0.5 rounded ${proj.type === 'subsidy' ? 'bg-blue-100 text-blue-900' : 'bg-sky-100 text-sky-600'}`}>{proj.type === 'subsidy' ? '補助款' : '配合款'}</span>
                                                                </div>
                                                                <p className="text-sm text-slate-500 mt-1">{proj.description}</p>
                                                            </div>
                                                            <div className="flex items-center gap-2">
                                                                <span className="text-slate-400">$</span>
                                                                <input type="text" key={`${currentYear}-${proj.id}`} defaultValue={budget ? budget.toLocaleString() : ''} onBlur={(e) => { const rawValue = e.target.value.replace(/,/g, ''); if (!isNaN(rawValue) && rawValue !== '') { handleBudgetUpdate(proj.id, rawValue); e.target.value = Number(rawValue).toLocaleString(); } }} onFocus={(e) => e.target.select()} className={inputStyle + " w-32 text-right font-bold text-slate-800"} />
                                                            </div>
                                                        </div>
                                                    );
                                                })}
                                                <div className="mt-6 pt-4 border-t border-slate-100 flex justify-end">
                                                    <div className="text-right">
                                                        <p className="text-sm text-slate-500">年度預算總計</p>
                                                        <p className="text-2xl font-bold text-blue-600">{formatCurrency(yearlyBudgets.filter(b => Number(b.year) === currentYear).reduce((sum, b) => sum + Number(b.amount), 0))}</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {/* Dashboard Tab */}
                                {activeTab === 'dashboard' && (
                                    <div className="space-y-6 animate-fade-in">
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                            {/* 補助款卡片 */}
                                            <div className="bg-white p-6 rounded-xl shadow-sm border border-blue-900 relative overflow-hidden">
                                                <div className="flex justify-between items-center mb-4">
                                                    <h4 className="text-blue-900 font-bold">補助款</h4>
                                                    <div className={`text-2xl font-bold ${summaryStats.subsidy.displayRemaining < 0 ? 'text-red-600' : 'text-blue-900'}`}>
                                                        {formatCurrency(summaryStats.subsidy.displayRemaining)}
                                                        <span className="text-sm text-slate-400 font-normal ml-1">剩餘</span>
                                                    </div>
                                                </div>
                                                <div className="w-full bg-slate-100 rounded-full h-2 mb-2">
                                                    <div className={`h-2 rounded-full ${summaryStats.subsidy.ratio > 100 ? 'bg-red-500' : 'bg-blue-800'}`} style={{ width: `${Math.min(summaryStats.subsidy.ratio, 100)}%` }}></div>
                                                </div>
                                                <div className="flex justify-between text-sm text-slate-500">
                                                    <span>已用(已歸檔): {formatCurrency(summaryStats.subsidy.displayUsed)}</span>
                                                    <span>總額: {formatCurrency(summaryStats.subsidy.displayTotal)}</span>
                                                </div>
                                            </div>

                                            {/* 配合款卡片 */}
                                            <div className="bg-white p-6 rounded-xl shadow-sm border border-sky-300 relative overflow-hidden">
                                                <div className="flex justify-between items-center mb-4">
                                                    <h4 className="text-sky-600 font-bold">配合款</h4>
                                                    <div className={`text-2xl font-bold ${summaryStats.matching.displayRemaining < 0 ? 'text-red-600' : 'text-sky-600'}`}>
                                                        {formatCurrency(summaryStats.matching.displayRemaining)}
                                                        <span className="text-sm text-slate-400 font-normal ml-1">剩餘</span>
                                                    </div>
                                                </div>
                                                <div className="w-full bg-slate-100 rounded-full h-2 mb-2">
                                                    <div className={`h-2 rounded-full ${summaryStats.matching.ratio > 100 ? 'bg-red-500' : 'bg-sky-400'}`} style={{ width: `${Math.min(summaryStats.matching.ratio, 100)}%` }}></div>
                                                </div>
                                                <div className="flex justify-between text-sm text-slate-500">
                                                    <span>已用(已歸檔): {formatCurrency(summaryStats.matching.displayUsed)}</span>
                                                    <span>總額: {formatCurrency(summaryStats.matching.displayTotal)}</span>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div className="bg-white rounded-xl shadow-sm border border-slate-300 overflow-hidden">
                                            <div className="px-6 py-4 border-b border-slate-200 flex justify-between items-center bg-slate-100">
                                                <h3 className="font-bold text-lg text-slate-800 flex items-center gap-2"><Table className="h-5 w-5 text-slate-600" /> 計畫執行狀況 ({currentYear}年)</h3>
                                            </div>
                                            <div className="overflow-x-auto">
                                                <table className="w-full text-sm text-left border-collapse">
                                                    <thead className="text-sm text-slate-700 uppercase bg-slate-200 border-b border-slate-300">
                                                        <tr>
                                                            <th className="px-4 py-3 border-r border-slate-300 min-w-[140px]">計畫經費項目</th>
                                                            <th className="px-4 py-3 text-right border-r border-slate-300 min-w-[100px]">總計(預算)</th>
                                                            <th className="px-4 py-3 text-right border-r border-slate-300 min-w-[100px]">支出總計</th>
                                                            <th className="px-4 py-3 text-right border-r border-slate-300 min-w-[100px] font-bold">剩餘金額</th>
                                                            <th className="px-4 py-3 text-center border-r border-slate-300 min-w-[80px]">執行率</th>
                                                            <th className="px-4 py-3 text-right border-r border-slate-300 bg-green-50 text-green-800 min-w-[90px]">已歸檔</th>
                                                            <th className="px-4 py-3 text-right border-r border-slate-300 bg-yellow-50 text-yellow-800 min-w-[90px]">送核銷</th>
                                                            <th className="px-4 py-3 text-right bg-red-50 text-red-800 min-w-[90px]">未核銷</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody className="divide-y divide-slate-200">
                                                        {projectStats.map((proj) => (
                                                            <tr key={proj.id} className="hover:bg-blue-50 transition-colors">
                                                                <td className="px-4 py-3 font-medium text-slate-800 border-r border-slate-200 flex items-center gap-2"><span className={`w-1 h-8 rounded ${proj.type === 'subsidy' ? 'bg-blue-800' : 'bg-sky-400'}`}></span>{proj.name}</td>
                                                                <td className="px-4 py-3 text-right text-slate-600 border-r border-slate-200">{formatCurrency(proj.totalBudget)}</td>
                                                                <td className="px-4 py-3 text-right text-slate-600 border-r border-slate-200">{formatCurrency(proj.totalUsed)}</td>
                                                                <td className={`px-4 py-3 text-right font-bold border-r border-slate-200 ${proj.remaining < 0 ? 'text-red-600' : 'text-green-600'}`}>{formatCurrency(proj.remaining)}</td>
                                                                <td className="px-4 py-3 text-center border-r border-slate-200">
                                                                    <div className={`flex flex-col items-center ${proj.isOverLimit ? 'text-red-600 font-bold' : 'text-slate-600'}`}>
                                                                        <span>{proj.ratio}%</span>
                                                                        {proj.isOverLimit && <span className="text-[10px] text-red-500">(超支)</span>}
                                                                    </div>
                                                                </td>
                                                                <td className="px-4 py-3 text-right text-green-700 border-r border-slate-200 bg-green-50/30">{proj.archived > 0 ? formatCurrency(proj.archived) : '-'}</td>
                                                                <td className="px-4 py-3 text-right text-yellow-700 border-r border-slate-200 bg-yellow-50/30">{proj.submitted > 0 ? formatCurrency(proj.submitted) : '-'}</td>
                                                                <td className="px-4 py-3 text-right text-red-700 bg-red-50/30">{proj.unsubmitted > 0 ? formatCurrency(proj.unsubmitted) : '-'}</td>
                                                            </tr>
                                                        ))}
                                                        {/* Total Row */}
                                                        <tr className="bg-slate-100 font-bold border-t-2 border-slate-300">
                                                            <td className="px-4 py-3 text-center border-r border-slate-300">總計</td>
                                                            <td className="px-4 py-3 text-right border-r border-slate-300">{formatCurrency(dashboardTotals.totalBudget)}</td>
                                                            <td className="px-4 py-3 text-right border-r border-slate-300">{formatCurrency(dashboardTotals.totalUsed)}</td>
                                                            <td className={`px-4 py-3 text-right border-r border-slate-300 ${dashboardTotals.remaining < 0 ? 'text-red-600' : 'text-green-600'}`}>{formatCurrency(dashboardTotals.remaining)}</td>
                                                            <td className="px-4 py-3 text-center border-r border-slate-300">
                                                                {dashboardTotals.totalBudget > 0 ? ((dashboardTotals.totalUsed / dashboardTotals.totalBudget) * 100).toFixed(2) : '0.00'}%
                                                            </td>
                                                            <td className="px-4 py-3 text-right border-r border-slate-300 bg-green-100 text-green-900">{formatCurrency(dashboardTotals.archived)}</td>
                                                            <td className="px-4 py-3 text-right border-r border-slate-300 bg-yellow-100 text-yellow-900">{formatCurrency(dashboardTotals.submitted)}</td>
                                                            <td className="px-4 py-3 text-right bg-red-100 text-red-900">{formatCurrency(dashboardTotals.unsubmitted)}</td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {/* Entry Tab */}
                                {activeTab === 'entry' && (
                                    <div className="max-w-[95%] mx-auto py-6 px-4 pb-24 animate-fade-in">
                                        <div className="sticky top-16 z-30 bg-white/95 backdrop-blur border border-slate-200 shadow-sm rounded-xl p-4 mb-6 flex flex-wrap gap-4 items-center justify-between">
                                            <div className="flex gap-4 flex-wrap items-center flex-1">
                                                <div className="flex items-center gap-2">
                                                    <Calendar className="w-5 h-5 text-slate-400" />
                                                    <div className="font-bold text-slate-700 text-lg">{batchHeader.year}年</div>
                                                </div>
                                                <select name="month" value={batchHeader.month} onChange={handleHeaderChange} className={inputStyle + " w-auto bg-slate-50"}>
                                                    {MONTHS.map(m => <option key={m} value={m}>{m}</option>)}
                                                </select>
                                                <select name="businessCategory" value={batchHeader.businessCategory} onChange={handleHeaderChange} className={inputStyle + " w-auto bg-slate-50"}>
                                                    {BUSINESS_CATEGORIES.map(c => <option key={c} value={c}>{c}</option>)}
                                                </select>
                                                {/* 活動名稱自動填滿剩餘空間 */}
                                                <input type="text" name="activityName" required placeholder="活動名稱" value={batchHeader.activityName} onChange={handleHeaderChange} className={inputStyle + " flex-1 min-w-[200px]"} />
                                            </div>
                                        </div>

                                        <datalist id="payee-suggestions">
                                            {commonPayees.map(name => <option key={name} value={name} />)}
                                        </datalist>

                                        <div className="space-y-4">
                                            {/* Table Header for Entry */}
                                            <div className="hidden md:block bg-slate-100 rounded-t-lg border border-slate-200 overflow-hidden">
                                                <table className="w-full text-left">
                                                    <thead>
                                                        <tr>
                                                            <th className={tableHeaderStyle + " w-[40px] text-center"}>#</th>
                                                            <th className={tableHeaderStyle + " min-w-[200px]"}>經費來源</th>
                                                            <th className={tableHeaderStyle + " min-w-[120px]"}>支出項目</th>
                                                            <th className={tableHeaderStyle + " min-w-[200px]"}>補充說明</th>
                                                            <th className={tableHeaderStyle + " min-w-[100px]"}>對象類型</th>
                                                            <th className={tableHeaderStyle + " min-w-[120px]"}>人員/單位名稱 <span className="text-red-500">*</span></th>
                                                            <th className={tableHeaderStyle + " min-w-[100px] text-right"}>單價</th>
                                                            <th className={tableHeaderStyle + " min-w-[80px] text-center"}>數量</th>
                                                            <th className={tableHeaderStyle + " min-w-[100px] text-right"}>總價</th>
                                                            <th className={tableHeaderStyle + " w-[50px]"}></th>
                                                        </tr>
                                                    </thead>
                                                </table>
                                            </div>

                                            {/* Single Table Body for Entry */}
                                            <div className="hidden md:block bg-white rounded-b-lg shadow-sm border-x border-b border-slate-200 overflow-x-auto" style={{maxHeight: 'calc(100vh - 300px)', overflowY: 'auto'}}>
                                                 <table className="w-full">
                                                     <tbody className="divide-y divide-slate-100">
                                                        {batchItems.map((item, index) => (
                                                            <tr key={item.id} className="hover:bg-slate-50 transition-colors align-top group animate-fade-in-down relative">
                                                                {/* Visual Cue inside the first cell */}
                                                                <td className="w-[40px] text-center p-2 text-slate-400 font-bold align-top pt-3 relative border-b border-slate-100">
                                                                    {index === batchItems.length - 1 && batchItems.length > 1 && (
                                                                        <div className="absolute left-0 top-0 bottom-0 w-1 bg-amber-400"></div>
                                                                    )}
                                                                    {index + 1}
                                                                </td>
                                                                <td className="px-2 py-2 border-b border-slate-100 align-top min-w-[200px]">
                                                                    <select value={item.project} onChange={(e) => handleItemChange(item.id, 'project', e.target.value)} className={tableInputStyle}>
                                                                        {projects.map(p => {
                                                                            const stats = projectStats.find(s=>s.id===p.id);
                                                                            return (
                                                                                <option key={p.id} value={p.name} className={getProjectStyle(p.name)}>
                                                                                    {p.name} 餘:{formatCurrency(stats?stats.remaining:0)}
                                                                                </option>
                                                                            );
                                                                        })}
                                                                    </select>
                                                                </td>
                                                                <td className="px-2 py-2 border-b border-slate-100 align-top min-w-[120px]">
                                                                    <select value={item.expenseType} onChange={(e) => handleItemChange(item.id, 'expenseType', e.target.value)} className={tableInputStyle}>
                                                                        {EXPENSE_TYPES.map(t => <option key={t} value={t}>{t}</option>)}
                                                                    </select>
                                                                    {/* 快捷按鈕區 */}
                                                                    <div className="flex flex-wrap gap-1 mt-1">
                                                                        {['出席費', '諮詢費'].includes(item.expenseType) && (
                                                                            <>
                                                                                <button type="button" onClick={() => handleItemChange(item.id, 'unitPrice', 2000)} className="text-[10px] px-1 py-0.5 bg-blue-50 text-blue-600 rounded border border-blue-200 hover:bg-blue-100">2000</button>
                                                                                <button type="button" onClick={() => handleItemChange(item.id, 'unitPrice', 2500)} className="text-[10px] px-1 py-0.5 bg-blue-50 text-blue-600 rounded border border-blue-200 hover:bg-blue-100">2500</button>
                                                                            </>
                                                                        )}
                                                                        {item.expenseType === '鐘點費' && (
                                                                            <>
                                                                                <button type="button" onClick={() => handleItemChange(item.id, 'unitPrice', 1000)} className="text-[10px] px-1 py-0.5 bg-purple-50 text-purple-600 rounded border border-purple-200 hover:bg-purple-100">1000</button>
                                                                                <button type="button" onClick={() => handleItemChange(item.id, 'unitPrice', 2000)} className="text-[10px] px-1 py-0.5 bg-purple-50 text-purple-600 rounded border border-purple-200 hover:bg-purple-100">2000</button>
                                                                            </>
                                                                        )}
                                                                        {item.expenseType === '餐點費' && (
                                                                            <>
                                                                                <button type="button" onClick={() => handleItemChange(item.id, 'unitPrice', 40)} className="text-[10px] px-1 py-0.5 bg-orange-50 text-orange-600 rounded border border-orange-200 hover:bg-orange-100">40</button>
                                                                                <button type="button" onClick={() => handleItemChange(item.id, 'unitPrice', 120)} className="text-[10px] px-1 py-0.5 bg-orange-50 text-orange-600 rounded border border-orange-200 hover:bg-orange-100">120</button>
                                                                            </>
                                                                        )}
                                                                    </div>
                                                                </td>
                                                                <td className="px-2 py-2 border-b border-slate-100 align-top min-w-[200px]">
                                                                    <input type="text" placeholder="細節說明" value={item.item} onChange={(e) => handleItemChange(item.id, 'item', e.target.value)} className={tableInputStyle} />
                                                                </td>
                                                                <td className="px-2 py-2 border-b border-slate-100 align-top min-w-[100px]">
                                                                    <select value={item.payeeCategory} onChange={(e) => handleItemChange(item.id, 'payeeCategory', e.target.value)} className={tableInputStyle}>
                                                                        {PAYEE_CATEGORIES.map(c => <option key={c} value={c}>{c}</option>)}
                                                                    </select>
                                                                </td>
                                                                <td className="px-2 py-2 border-b border-slate-100 align-top min-w-[120px]">
                                                                    <input type="text" placeholder="請輸入姓名" value={item.payeeName} onChange={(e) => handleItemChange(item.id, 'payeeName', e.target.value)} list={item.payeeCategory === '業師' ? "payee-suggestions" : undefined} className={tableInputStyle} />
                                                                </td>
                                                                <td className="px-2 py-2 border-b border-slate-100 align-top min-w-[100px]">
                                                                    <input type="number" placeholder="0" value={item.unitPrice} onChange={(e) => handleItemChange(item.id, 'unitPrice', e.target.value)} className={tableInputStyle + " text-right font-mono"} />
                                                                </td>
                                                                <td className="px-2 py-2 border-b border-slate-100 align-top min-w-[80px]">
                                                                    <input type="number" placeholder="1" value={item.quantity} onChange={(e) => handleItemChange(item.id, 'quantity', e.target.value)} className={tableInputStyle + " text-center font-mono"} />
                                                                </td>
                                                                <td className="px-2 py-2 border-b border-slate-100 align-top min-w-[100px] text-right pt-3">
                                                                    <span className="font-bold text-blue-600 font-mono">{formatCurrency(Math.round((Number(item.unitPrice) || 0) * (Number(item.quantity) || 0)))}</span>
                                                                </td>
                                                                <td className="px-2 py-2 border-b border-slate-100 align-top w-[50px] text-center pt-2">
                                                                    <button type="button" onClick={() => removeItemRow(item.id)} className="text-slate-300 hover:text-red-500 transition-colors"><Trash2 className="h-5 w-5" /></button>
                                                                </td>
                                                            </tr>
                                                        ))}
                                                     </tbody>
                                                 </table>
                                            </div>
                                            {/* *** 修正結束 *** */}

                                            {/* Mobile View: Stacked Card (Fallback) */}
                                            <div className="md:hidden grid grid-cols-1 gap-3 p-3">
                                                {batchItems.map((item, index) => (
                                                    <div key={item.id} className="bg-white rounded-lg shadow-sm border border-slate-200 p-4 relative">
                                                         <div className="flex justify-between items-center mb-2">
                                                            <span className="font-bold text-slate-500">#{index + 1}</span>
                                                            <button type="button" onClick={() => removeItemRow(item.id)} className="text-red-400"><Trash2 className="h-5 w-5" /></button>
                                                        </div>
                                                        <div className="grid grid-cols-1 gap-2">
                                                             <select value={item.project} onChange={(e) => handleItemChange(item.id, 'project', e.target.value)} className={inputStyle}>
                                                                {projects.map(p => <option key={p.id} value={p.name}>{p.name}</option>)}
                                                            </select>
                                                            {/* ... (其他手機版欄位，保持原樣或簡化) ... */}
                                                            <input type="text" placeholder="姓名" value={item.payeeName} onChange={(e) => handleItemChange(item.id, 'payeeName', e.target.value)} className={inputStyle} />
                                                            <div className="flex gap-2">
                                                                <input type="number" placeholder="單價" value={item.unitPrice} onChange={(e) => handleItemChange(item.id, 'unitPrice', e.target.value)} className={inputStyle} />
                                                                <input type="number" placeholder="數量" value={item.quantity} onChange={(e) => handleItemChange(item.id, 'quantity', e.target.value)} className={inputStyle} />
                                                            </div>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>

                                        <div className="fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur border-t border-slate-200 p-4 z-30 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)]">
                                            <div className="max-w-7xl mx-auto flex justify-between items-center">
                                                <div className="flex gap-3">
                                                    <button type="button" onClick={addItemRow} className="hidden md:flex items-center gap-2 text-slate-600 hover:text-blue-600 px-4 py-2 rounded-lg hover:bg-slate-100 transition-colors font-medium border border-slate-200"><Plus className="h-5 w-5" /> 新增明細</button>
                                                    <button type="button" onClick={addItemRow} className="md:hidden p-2 rounded-full bg-slate-100 text-slate-600"><Plus className="h-6 w-6" /></button>
                                                    
                                                    <button type="button" onClick={addPremiumRow} className="hidden md:flex items-center gap-2 text-purple-600 hover:text-purple-700 px-4 py-2 rounded-lg hover:bg-purple-50 transition-colors border border-purple-200 font-medium"><Coins className="h-5 w-5" /> 保費</button>
                                                </div>
                                                <div className="flex items-center gap-4">
                                                    <div className="flex flex-col items-end">
                                                        <div className="flex items-baseline gap-2">
                                                            <span className="text-sm text-slate-500">本批次總金額</span>
                                                            <span className="text-2xl font-bold text-slate-800 font-mono">{formatCurrency(batchTotal)}</span>
                                                        </div>
                                                        <div className="text-[10px] text-slate-400 flex gap-2">
                                                            <span>(補助款餘額: {formatCurrency(summaryStats.subsidy.remaining)})</span>
                                                            <span>(配合款餘額: {formatCurrency(summaryStats.matching.remaining)})</span>
                                                        </div>
                                                    </div>
                                                    <button type="button" onClick={handleBatchSubmit} className="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2.5 rounded-lg font-bold shadow-lg shadow-blue-200 hover:shadow-blue-300 transition-all flex items-center gap-2 transform active:scale-95"><Save className="h-5 w-5" /> 儲存</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {/* Log Tab */}
                                {activeTab === 'log' && (
                                    <div className="bg-white rounded-xl shadow-sm border border-slate-200 animate-fade-in overflow-hidden">
                                        <div className="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                                            <div className="flex flex-col gap-2 w-full">
                                                <div className="flex justify-between items-center">
                                                    <h3 className="font-bold text-lg text-slate-800 flex items-center gap-2"><FileText className="h-5 w-5 text-slate-500" /> 明細紀錄 ({currentYear}年)</h3>
                                                    <span className="text-xs font-mono text-slate-400">Total Activities: {groupedTransactions.length}</span>
                                                </div>
                                                
                                                {/* 篩選工具列 */}
                                                <div className="flex flex-wrap gap-2 items-center text-sm">
                                                    {/* 1. Status */}
                                                    <div className="flex items-center gap-1 bg-slate-100 rounded-lg px-2 py-1 border border-slate-200">
                                                        <ListFilter className="w-3 h-3 text-slate-400" />
                                                        <select value={filterStatus} onChange={(e) => setFilterStatus(e.target.value)} className="bg-transparent font-medium text-slate-600 focus:outline-none border-none cursor-pointer">
                                                            <option value="全部">全部狀態</option>
                                                            {STATUS_OPTIONS.map(s => <option key={s} value={s}>{s}</option>)}
                                                        </select>
                                                    </div>

                                                    {/* 2. Category */}
                                                    <div className="flex items-center gap-1 bg-slate-100 rounded-lg px-2 py-1 border border-slate-200">
                                                        <Filter className="w-3 h-3 text-slate-400" />
                                                        <select value={filterCategory} onChange={(e) => setFilterCategory(e.target.value)} className="bg-transparent font-medium text-slate-600 focus:outline-none border-none cursor-pointer">
                                                            <option value="全部">全部類別</option>
                                                            {BUSINESS_CATEGORIES.map(c => <option key={c} value={c}>{c}</option>)}
                                                        </select>
                                                    </div>

                                                    {/* 3. Month */}
                                                    <div className="flex items-center gap-1 bg-slate-100 rounded-lg px-2 py-1 border border-slate-200">
                                                        <Calendar className="w-3 h-3 text-slate-400" />
                                                        <select value={filterMonth} onChange={(e) => setFilterMonth(e.target.value)} className="bg-transparent font-medium text-slate-600 focus:outline-none border-none cursor-pointer">
                                                            <option value="全部">全部月份</option>
                                                            {MONTHS.map(m => <option key={m} value={m}>{m}</option>)}
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div className="overflow-x-auto">
                                            <table className="w-full text-sm text-left">
                                                <thead className="text-sm text-slate-500 uppercase bg-slate-100 border-b border-slate-200">
                                                    <tr>
                                                        <th className="px-4 py-3 w-[40px]"></th>
                                                        <th className="px-4 py-3 w-[110px] text-center">狀態</th>
                                                        <th className="px-4 py-3 w-[90px] text-center">歸屬月份</th>
                                                        <th className="px-4 py-3 w-auto min-w-[200px]">活動名稱</th>
                                                        <th className="px-4 py-3 w-[110px] text-right text-blue-900">補助款</th> 
                                                        <th className="px-4 py-3 w-[110px] text-right text-sky-600">配合款</th> 
                                                        <th className="px-4 py-3 w-[110px] text-right">總金額</th>
                                                        <th className="px-4 py-3 w-[140px] text-right">操作</th>
                                                    </tr>
                                                </thead>
                                                <tbody className="divide-y divide-slate-100">
                                                    {groupedTransactions.map((group) => (
                                                        <React.Fragment key={group.key}>
                                                            <tr className="hover:bg-blue-50 transition-colors cursor-pointer group border-l-4 border-l-transparent hover:border-l-blue-500" onClick={() => toggleGroup(group.key)}>
                                                                <td className="px-4 py-4 text-slate-400 text-center w-[40px]">{expandedGroups[group.key] ? <ChevronDown className="w-4 h-4" /> : <ChevronRight className="w-4 h-4" />}</td>
                                                                <td className="px-4 py-4 text-center w-[110px]">
                                                                    <div className="flex flex-col items-center gap-1 w-full">
                                                                        <span className={`inline-flex items-center px-2 py-0.5 rounded text-xs font-medium border w-full justify-center ${group.status === '已歸檔' ? 'bg-green-50 text-green-700 border-green-200' : group.status === '送核銷' ? 'bg-yellow-50 text-yellow-700 border-yellow-200' : 'bg-red-50 text-red-700 border-red-200'}`}>{group.status}</span>
                                                                        {group.id && <span className="text-[10px] text-slate-400 font-mono tracking-tighter w-full break-all whitespace-normal block" title={group.id}>{group.id}</span>}
                                                                    </div>
                                                                </td>
                                                                <td className="px-4 py-4 text-slate-600 font-medium whitespace-nowrap w-[1%]">{group.month}</td>
                                                                <td className="px-4 py-4 font-bold text-slate-800 text-base break-words w-auto min-w-[200px]">
                                                                    <div className="flex flex-wrap items-center gap-2">
                                                                        {group.businessCategory && (
                                                                            <span className={`text-[10px] px-1.5 py-0.5 rounded border ${getCategoryStyle(group.businessCategory)}`}>
                                                                                [{group.businessCategory}]
                                                                            </span>
                                                                        )}
                                                                        <span>{group.activityName}</span>
                                                                        <span className="ml-2 text-xs font-normal text-slate-400 bg-slate-100 px-2 py-0.5 rounded-full whitespace-nowrap">{group.items.length} 筆明細</span>
                                                                    
                                                                        {/* Group Edit Button */}
                                                                        {group.status === '未核銷' && (
                                                                            <button 
                                                                                onClick={(e) => { e.stopPropagation(); handleStartGroupEdit(group); }} 
                                                                                className="p-1 text-slate-300 hover:text-blue-500 rounded-full hover:bg-blue-50 transition-colors ml-auto"
                                                                            >
                                                                                <Edit className="w-3 h-3" />
                                                                            </button>
                                                                        )}
                                                                    </div>
                                                                </td>
                                                                <td className="px-4 py-4 text-right font-medium text-blue-900 w-[110px]">{formatCurrency(group.subsidyAmount)}</td>
                                                                <td className="px-4 py-4 text-right font-medium text-sky-600 w-[110px]">{formatCurrency(group.matchingAmount)}</td>
                                                                <td className="px-4 py-4 text-right font-bold text-slate-800 w-[110px]">{formatCurrency(group.totalAmount)}</td>
                                                                <td className="px-4 py-4 w-[140px] text-right">
                                                                    <div className="flex justify-end gap-1 items-center">
                                                                        {group.status === '未核銷' && (
                                                                            <button onClick={(e) => handleOpenStatusModal(e, 'promote_to_submitted', group.items)} className="p-1.5 rounded hover:bg-blue-100 text-blue-600 transition-colors" title="送出核銷"><ArrowRightCircle className="w-4 h-4" /></button>
                                                                        )}
                                                                        {group.status === '送核銷' && (
                                                                            <>
                                                                                <button onClick={(e) => handleOpenStatusModal(e, 'promote_to_archived', group.items)} className="p-1.5 rounded hover:bg-green-100 text-green-600 transition-colors" title="完成歸檔"><CheckCircle className="w-4 h-4" /></button>
                                                                                <button onClick={(e) => handleOpenStatusModal(e, 'rollback_to_pending', group.items)} className="p-1.5 rounded hover:bg-slate-200 text-slate-400 transition-colors" title="退回未核銷"><RotateCcw className="w-4 h-4" /></button>
                                                                            </>
                                                                        )}
                                                                        {group.status === '已歸檔' && (
                                                                            <button onClick={(e) => handleOpenStatusModal(e, 'rollback_to_submitted', group.items)} className="p-1.5 rounded hover:bg-slate-200 text-slate-300 hover:text-slate-500 transition-colors" title="退回送核銷 (修改日期/重送)"><RotateCcw className="w-4 h-4" /></button>
                                                                        )}
                                                                        <div className="w-[1px] h-4 bg-slate-200 mx-1"></div>
                                                                        <button onClick={(e) => handleDeleteGroup(e, group.items)} className="text-slate-300 hover:text-red-500 p-1.5 rounded transition-colors" title="刪除整筆活動"><Trash2 className="w-4 h-4" /></button>
                                                                    </div>
                                                                </td>
                                                            </tr>
                                                            
                                                            {/* Group Edit Form */}
                                                            {editingGroupKey === group.key && (
                                                                <tr>
                                                                    <td colSpan="8" className="bg-blue-50 p-4 border-b border-blue-200">
                                                                        <div className="flex flex-wrap gap-4 items-center">
                                                                            <div className="flex gap-2 items-center">
                                                                                <span className="text-xs font-bold text-blue-800">修改活動資訊:</span>
                                                                                <select 
                                                                                    value={editGroupData.month} 
                                                                                    onChange={e => setEditGroupData({...editGroupData, month: e.target.value})}
                                                                                    className="text-sm rounded border border-blue-300 px-2 py-1"
                                                                                >
                                                                                    {MONTHS.map(m => <option key={m} value={m}>{m}</option>)}
                                                                                </select>
                                                                                <select 
                                                                                    value={editGroupData.businessCategory} 
                                                                                    onChange={e => setEditGroupData({...editGroupData, businessCategory: e.target.value})}
                                                                                    className="text-sm rounded border border-blue-300 px-2 py-1"
                                                                                >
                                                                                    {BUSINESS_CATEGORIES.map(c => <option key={c} value={c}>{c}</option>)}
                                                                                </select>
                                                                                <input 
                                                                                    type="text" 
                                                                                    value={editGroupData.activityName} 
                                                                                    onChange={e => setEditGroupData({...editGroupData, activityName: e.target.value})}
                                                                                    className="text-sm rounded border border-blue-300 px-2 py-1 w-64"
                                                                                />
                                                                            </div>
                                                                            <div className="flex gap-2 ml-auto">
                                                                                <button 
                                                                                    onClick={() => handleSaveGroupEdit(group.items)}
                                                                                    className="px-3 py-1 bg-blue-600 text-white rounded text-sm hover:bg-blue-700"
                                                                                >
                                                                                    儲存修改
                                                                                </button>
                                                                                <button 
                                                                                    onClick={handleCancelGroupEdit}
                                                                                    className="px-3 py-1 bg-white text-slate-600 border border-slate-300 rounded text-sm hover:bg-slate-50"
                                                                                >
                                                                                    取消
                                                                                </button>
                                                                            </div>
                                                                        </div>
                                                                    </td>
                                                                </tr>
                                                            )}

                                                            {expandedGroups[group.key] && (
                                                                <tr>
                                                                    <td colSpan="8" className="bg-slate-50 p-4 border-b border-slate-200 shadow-inner">
                                                                        <div className="bg-white rounded-lg border border-slate-200 overflow-hidden">
                                                                            <table className="w-full text-xs">
                                                                                <thead className="bg-slate-100 text-slate-500 uppercase">
                                                                                    <tr>
                                                                                        <th className="px-4 py-2 text-left w-[14%] whitespace-nowrap">經費來源</th>
                                                                                        <th className="px-4 py-2 text-left w-[10%] whitespace-nowrap">支出項目</th>
                                                                                        <th className="px-4 py-2 text-left w-[33%] min-w-[200px]">補充說明</th>
                                                                                        <th className="px-4 py-2 text-left w-[15%] whitespace-nowrap">對象</th>
                                                                                        <th className="px-4 py-2 text-right w-[10%] whitespace-nowrap">單價</th>
                                                                                        <th className="px-4 py-2 text-center w-[8%] whitespace-nowrap">數量</th>
                                                                                        <th className="px-4 py-2 text-right w-[10%] whitespace-nowrap">總價</th>
                                                                                        <th className="px-4 py-2 w-[30px]"></th>
                                                                                    </tr>
                                                                                </thead>
                                                                                <tbody className="divide-y divide-slate-100">
                                                                                    {group.items.map((item, idx) => (
                                                                                        <tr key={item.uid || idx} className="hover:bg-slate-50">
                                                                                            {editingId === item.uid ? (
                                                                                                <>
                                                                                                    <td className="px-2 py-2"><select value={editFormData.project} onChange={(e) => handleEditFormChange('project', e.target.value)} className="w-full rounded border-slate-300 text-xs">{projects.map(p => <option key={p.id} value={p.name}>{p.name}</option>)}</select></td>
                                                                                                    <td className="px-2 py-2"><select value={editFormData.expenseType} onChange={(e) => handleEditFormChange('expenseType', e.target.value)} className="w-full rounded border-slate-300 text-xs">{EXPENSE_TYPES.map(t => <option key={t} value={t}>{t}</option>)}</select></td>
                                                                                                    <td className="px-2 py-2"><input type="text" value={editFormData.item} onChange={(e) => handleEditFormChange('item', e.target.value)} className="w-full rounded border-slate-300 text-xs" /></td>
                                                                                                    <td className="px-2 py-2"><div className="flex flex-col gap-1"><select value={editFormData.payeeCategory} onChange={(e) => handleEditFormChange('payeeCategory', e.target.value)} className="w-full rounded border-slate-300 text-[10px]">{PAYEE_CATEGORIES.map(c => <option key={c} value={c}>{c}</option>)}</select><input type="text" value={editFormData.payeeName} onChange={(e) => handleEditFormChange('payeeName', e.target.value)} className="w-full rounded border-slate-300 text-xs" /></div></td>
                                                                                                    <td className="px-2 py-2 text-right"><input type="number" value={editFormData.unitPrice} onChange={(e) => handleEditFormChange('unitPrice', e.target.value)} className="w-20 rounded border-slate-300 text-xs text-right" /></td>
                                                                                                    <td className="px-2 py-2 text-center"><input type="number" value={editFormData.quantity} onChange={(e) => handleEditFormChange('quantity', e.target.value)} className="w-12 rounded border-slate-300 text-xs text-center" /></td>
                                                                                                    <td className="px-4 py-2 text-right font-bold text-slate-800">{formatCurrency(Math.round((Number(editFormData.unitPrice) || 0) * (Number(editFormData.quantity) || 0)))}</td>
                                                                                                    <td className="px-2 py-2 text-center"><div className="flex gap-1"><button onClick={handleSaveEdit} className="text-green-600 hover:bg-green-50 p-1 rounded"><Check className="w-4 h-4"/></button><button onClick={handleCancelEdit} className="text-slate-400 hover:bg-slate-100 p-1 rounded"><X className="w-4 h-4"/></button></div></td>
                                                                                                </>
                                                                                            ) : (
                                                                                                <>
                                                                                                    <td className="px-4 py-2 font-medium text-slate-700 whitespace-nowrap">{item.project}</td>
                                                                                                    <td className="px-4 py-2 text-blue-600 whitespace-nowrap">{item.expenseType}</td>
                                                                                                    <td className="px-4 py-2 text-slate-600 break-words">{item.item}</td>
                                                                                                    <td className="px-4 py-2 text-slate-600 whitespace-nowrap"><span className="text-[10px] bg-slate-100 px-1 rounded mr-1">{item.payeeCategory}</span>{item.payeeName}</td>
                                                                                                    <td className="px-4 py-2 text-right text-slate-500 whitespace-nowrap">{formatCurrency(item.unitPrice)}</td>
                                                                                                    <td className="px-4 py-2 text-center text-slate-500 whitespace-nowrap">{item.quantity}</td>
                                                                                                    <td className="px-4 py-2 text-right font-bold text-slate-800 whitespace-nowrap">{formatCurrency(item.amount)}</td>
                                                                                                    <td className="px-2 py-2 text-center">
                                                                                                        {group.status === '未核銷' ? (
                                                                                                            <button onClick={() => handleStartEdit(item)} className="text-slate-300 hover:text-blue-500 p-1 rounded transition-colors"><Pencil className="w-3 h-3" /></button>
                                                                                                        ) : (
                                                                                                            <span className="text-slate-200 cursor-not-allowed" title="請先退回未核銷狀態後再編輯"><Lock className="w-3 h-3" /></span>
                                                                                                        )}
                                                                                                    </td>
                                                                                                </>
                                                                                            )}
                                                                                        </tr>
                                                                                    ))}
                                                                                </tbody>
                                                                            </table>
                                                                        </div>
                                                                    </td>
                                                                </tr>
                                                            )}
                                                        </React.Fragment>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                )}

                                {/* Report Tab (Matrix Report) */}
                                {activeTab === 'report' && (
                                    <div className="max-w-7xl mx-auto py-6 px-4 animate-fade-in">
                                        <div className="bg-white rounded-xl shadow-lg border border-slate-100 overflow-hidden">
                                            <div className="bg-blue-600 px-6 py-4 text-white">
                                                <h3 className="font-bold text-lg flex items-center gap-2"><BarChart2 className="h-5 w-5" /> 經費支出一覽表</h3>
                                            </div>
                                            <div className="overflow-x-auto">
                                                <table className="w-full text-sm border-collapse">
                                                    <thead>
                                                        <tr>
                                                            {/* Fixed Columns */}
                                                            <th className="bg-slate-100 border border-slate-300 px-4 py-2 text-center font-bold text-slate-700 sticky left-0 z-20 w-[80px] min-w-[80px] max-w-[80px]">月份</th>
                                                            <th className="bg-slate-100 border border-slate-300 px-4 py-2 text-center font-bold text-slate-700 sticky left-[80px] z-20 w-[80px] min-w-[80px] max-w-[80px]">類別</th>
                                                            <th className="bg-slate-100 border border-slate-300 px-4 py-2 text-center font-bold text-slate-700 sticky left-[160px] z-20 w-[200px] min-w-[200px]">活動名稱</th>
                                                            
                                                            {/* Project Columns */}
                                                            {projects.map(p => (
                                                                <th key={p.id} className="bg-slate-50 border border-slate-300 px-4 py-2 text-center font-bold text-slate-600 min-w-[100px] whitespace-nowrap">
                                                                    {p.name.replace('職涯-', '')}
                                                                </th>
                                                            ))}
                                                            
                                                            <th className="bg-blue-50 border border-blue-200 px-4 py-2 text-center font-bold text-blue-800 min-w-[100px]">總計</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {matrixReport.rows.map((row, idx) => (
                                                            <tr key={idx} className="hover:bg-slate-50">
                                                                <td className="border border-slate-200 px-4 py-2 text-center sticky left-0 bg-white z-10 font-medium text-slate-600">{row.month}</td>
                                                                <td className="border border-slate-200 px-4 py-2 text-center sticky left-[80px] bg-white z-10">
                                                                    <span className={`text-xs px-2 py-1 rounded border ${getCategoryStyle(row.businessCategory)}`}>
                                                                        {row.businessCategory}
                                                                    </span>
                                                                </td>
                                                                <td className="border border-slate-200 px-4 py-2 font-bold text-slate-800 sticky left-[160px] bg-white z-10">
                                                                    {row.activityName}
                                                                </td>
                                                                
                                                                {projects.map(p => {
                                                                    const val = row.projectAmounts[p.name];
                                                                    return (
                                                                        <td key={p.id} className="border border-slate-200 px-4 py-2 text-right text-slate-600">
                                                                            {val ? val.toLocaleString() : '-'}
                                                                        </td>
                                                                    );
                                                                })}
                                                                
                                                                <td className="border border-blue-100 bg-blue-50/30 px-4 py-2 text-right font-bold text-blue-700">{row.total.toLocaleString()}</td>
                                                            </tr>
                                                        ))}

                                                        {/* Total Row */}
                                                        <tr className="bg-slate-100 font-bold border-t-2 border-slate-300">
                                                            <td className="border border-slate-300 px-4 py-3 text-center sticky left-0 bg-slate-100 z-10" colSpan={3}>年度總計</td>
                                                            {projects.map(p => (
                                                                <td key={p.id} className="border border-slate-300 px-4 py-3 text-right text-slate-800">
                                                                    {matrixReport.colTotals[p.name]?.toLocaleString() || 0}
                                                                </td>
                                                            ))}
                                                            <td className="border border-blue-300 bg-blue-100 px-4 py-3 text-right text-blue-900 text-lg">
                                                                {matrixReport.grandTotal.toLocaleString()}
                                                            </td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {/* Query Tab */}
                                {activeTab === 'query' && (
                                    <div className="max-w-3xl mx-auto animate-fade-in">
                                        <div className="bg-white rounded-xl shadow-lg border border-slate-100 overflow-hidden">
                                            <div className="bg-blue-600 px-6 py-4 text-white">
                                                <h3 className="font-bold text-lg flex items-center gap-2"><Search className="h-5 w-5" /> 查詢統計</h3>
                                            </div>
                                            <div className="p-6">
                                                
                                                {/* 1. 搜尋區 */}
                                                <div className="flex gap-2 mb-8">
                                                    <div className="relative flex-1">
                                                        <User className="absolute left-3 top-3 h-5 w-5 text-slate-400" />
                                                        <input 
                                                            type="text" 
                                                            placeholder="請輸入姓名或單位名稱 (精確搜尋)..." 
                                                            className="w-full pl-10 pr-4 py-2.5 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                                            value={searchQuery}
                                                            onChange={(e) => setSearchQuery(e.target.value)}
                                                        />
                                                    </div>
                                                </div>

                                                {searchResult && (
                                                    <div className="space-y-6 animate-fade-in-down mb-8">
                                                        <div className="grid grid-cols-2 gap-4">
                                                            <div className="bg-slate-50 p-4 rounded-lg border border-slate-200 text-center">
                                                                <p className="text-sm text-slate-500 mb-1">總筆數</p>
                                                                <p className="text-2xl font-bold text-slate-700">{searchResult.count} 筆</p>
                                                            </div>
                                                            <div className="bg-blue-50 p-4 rounded-lg border border-blue-200 text-center">
                                                                <p className="text-sm text-blue-600 mb-1">總金額</p>
                                                                <p className="text-2xl font-bold text-blue-700">{formatCurrency(searchResult.totalAmount)}</p>
                                                            </div>
                                                        </div>

                                                        <div className="border rounded-lg overflow-hidden">
                                                            <table className="w-full text-sm text-left">
                                                                <thead className="bg-slate-100 text-slate-500">
                                                                    <tr>
                                                                        <th className="px-4 py-3 whitespace-nowrap">月份</th>
                                                                        <th className="px-4 py-3">活動名稱</th>
                                                                        <th className="px-4 py-3 text-right whitespace-nowrap">金額</th>
                                                                        <th className="px-4 py-3 text-center whitespace-nowrap">狀態</th>
                                                                    </tr>
                                                                </thead>
                                                                <tbody className="divide-y divide-slate-100">
                                                                    {searchResult.items.map((item, idx) => (
                                                                        <tr key={idx} className="hover:bg-slate-50">
                                                                            <td className="px-4 py-3 text-slate-600 whitespace-nowrap w-[1%]">{item.month}</td>
                                                                            <td className="px-4 py-3 font-medium text-slate-800">{item.activityName}</td>
                                                                            <td className="px-4 py-3 text-right font-bold text-slate-700 whitespace-nowrap w-[1%]">{formatCurrency(item.amount)}</td>
                                                                            <td className="px-4 py-3 text-center whitespace-nowrap w-[1%]">
                                                                                <span className={`inline-flex items-center px-2 py-0.5 rounded text-xs font-medium border ${item.status === '已歸檔' ? 'bg-green-50 text-green-700 border-green-200' : item.status === '送核銷' ? 'bg-yellow-50 text-yellow-700 border-yellow-200' : 'bg-red-50 text-red-700 border-red-200'}`}>{item.status}</span>
                                                                            </td>
                                                                        </tr>
                                                                    ))}
                                                                </tbody>
                                                            </table>
                                                            {searchResult.count === 0 && (
                                                                <div className="p-8 text-center text-slate-400">
                                                                    <p>沒有找到符合 "{searchQuery}" 的資料</p>
                                                                </div>
                                                            )}
                                                        </div>
                                                    </div>
                                                )}

                                                {/* 3. 年度對象名錄 (沒有搜尋時顯示) */}
                                                {!searchQuery && (
                                                    <div>
                                                        <h4 className="text-lg font-bold text-slate-700 mb-4 flex items-center gap-2">
                                                            <Users className="w-5 h-5 text-blue-500" /> 年度對象名錄
                                                        </h4>
                                                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                                            
                                                            {/* 業師 */}
                                                            <div className="bg-slate-50 rounded-xl border border-slate-200 p-4">
                                                                <div className="flex items-center gap-2 mb-3 text-blue-700 font-bold border-b border-slate-200 pb-2">
                                                                    <GraduationCap className="w-4 h-4" /> 業師清單
                                                                </div>
                                                                <div className="flex flex-col gap-2 max-h-[300px] overflow-y-auto pr-2 custom-scrollbar">
                                                                    {payeeSummary['業師']?.map((item, idx) => (
                                                                        <button 
                                                                            key={idx}
                                                                            onClick={() => handlePayeeClick(item.name)}
                                                                            className="flex justify-between items-center text-sm p-2 rounded hover:bg-white hover:shadow-sm transition-all text-left group"
                                                                        >
                                                                            <span className="font-medium text-slate-700 group-hover:text-blue-600">{item.name}</span>
                                                                            <div className="text-right">
                                                                                <div className="text-xs font-bold text-slate-600">{formatCurrency(item.total)}</div>
                                                                                <div className="text-[10px] text-slate-400">{item.count} 筆</div>
                                                                            </div>
                                                                        </button>
                                                                    ))}
                                                                    {payeeSummary['業師']?.length === 0 && <p className="text-xs text-slate-400 text-center py-4">無資料</p>}
                                                                </div>
                                                            </div>

                                                            {/* 個人 */}
                                                            <div className="bg-slate-50 rounded-xl border border-slate-200 p-4">
                                                                <div className="flex items-center gap-2 mb-3 text-emerald-700 font-bold border-b border-slate-200 pb-2">
                                                                    <User className="w-4 h-4" /> 個人清單
                                                                </div>
                                                                <div className="flex flex-col gap-2 max-h-[300px] overflow-y-auto pr-2 custom-scrollbar">
                                                                    {payeeSummary['個人']?.map((item, idx) => (
                                                                        <button 
                                                                            key={idx}
                                                                            onClick={() => handlePayeeClick(item.name)}
                                                                            className="flex justify-between items-center text-sm p-2 rounded hover:bg-white hover:shadow-sm transition-all text-left group"
                                                                        >
                                                                            <span className="font-medium text-slate-700 group-hover:text-emerald-600">{item.name}</span>
                                                                            <div className="text-right">
                                                                                <div className="text-xs font-bold text-slate-600">{formatCurrency(item.total)}</div>
                                                                                <div className="text-[10px] text-slate-400">{item.count} 筆</div>
                                                                            </div>
                                                                        </button>
                                                                    ))}
                                                                    {payeeSummary['個人']?.length === 0 && <p className="text-xs text-slate-400 text-center py-4">無資料</p>}
                                                                </div>
                                                            </div>

                                                            {/* 廠商 */}
                                                            <div className="bg-slate-50 rounded-xl border border-slate-200 p-4">
                                                                <div className="flex items-center gap-2 mb-3 text-orange-700 font-bold border-b border-slate-200 pb-2">
                                                                    <Building2 className="w-4 h-4" /> 廠商清單
                                                                </div>
                                                                <div className="flex flex-col gap-2 max-h-[300px] overflow-y-auto pr-2 custom-scrollbar">
                                                                    {payeeSummary['廠商']?.map((item, idx) => (
                                                                        <button 
                                                                            key={idx}
                                                                            onClick={() => handlePayeeClick(item.name)}
                                                                            className="flex justify-between items-center text-sm p-2 rounded hover:bg-white hover:shadow-sm transition-all text-left group"
                                                                        >
                                                                            <span className="font-medium text-slate-700 group-hover:text-orange-600">{item.name}</span>
                                                                            <div className="text-right">
                                                                                <div className="text-xs font-bold text-slate-600">{formatCurrency(item.total)}</div>
                                                                                <div className="text-[10px] text-slate-400">{item.count} 筆</div>
                                                                            </div>
                                                                        </button>
                                                                    ))}
                                                                    {payeeSummary['廠商']?.length === 0 && <p className="text-xs text-slate-400 text-center py-4">無資料</p>}
                                                                </div>
                                                            </div>

                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </>
                        )}
                    </div>
                </div>
            );
        }

        // --- 啟動 React ---
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ExpenseTrackerApp />);
    </script>
</body>
</html>
